<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>uuid45 WASM Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 1rem; }
    input[type=text] { width: 480px; max-width: 100%; }
    code { background: #f4f4f4; padding: 2px 4px; }
    .row { margin: 0.5rem 0; }
  </style>
</head>
<body>
  <h1>uuid45 WASM Demo</h1>
  <p>Generate UUID v4, encode to Base45 compact string, and decode back.</p>

  <div class="row">
    <button id="btn-gen">Generate v4</button>
    <span id="uuid"></span>
  </div>

  <div class="row">
    <label>UUID input: <input type="text" id="uuid-in" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"></label>
    <button id="btn-enc">Encode</button>
  </div>
  <div class="row">
    <label>Base45: <code id="b45"></code></label>
    <button id="btn-qr" style="margin-left:8px; display:none;">Generate a QR</button>
  </div>
  <div class="row" id="qr-config" style="display:none;">
    <label>URL prefix: <input type="text" id="qr-prefix" placeholder="https://example.com/data/" style="width:480px; max-width:100%"></label>
    <button id="btn-qr-confirm">Confirm</button>
  </div>
  <div class="row" id="qr-info" style="display:none;"></div>
  <div class="row" id="qr-options" style="display:none;"></div>
  <div class="row" id="qr-view"></div>

  <div class="row">
    <label>Base45 input: <input type="text" id="b45-in" placeholder="Base45 string"></label>
    <button id="btn-dec">Decode</button>
  </div>
  <div class="row">
    <label>Decoded UUID: <code id="uuid-out"></code></label>
  </div>

  <script type="module">
    import init, { wasm_gen_v4, wasm_encode_uuid_str, wasm_decode_to_uuid_str } from './pkg/uuid45.js';

    // Minimal QR renderer using qrcode-generator (inline ESM loader)
    // We will dynamically import a small QR lib from CDN to keep this example simple.
    async function loadQRLIB() {
      if (window.qrcode) return window.qrcode; // function qrcode(typeNumber, errorCorrectLevel)
      // Prefer local vendor copy to avoid CDN dependency
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = './vendor/qrcode.js?v=' + Date.now();
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load local vendor qrcode.js'));
        document.head.appendChild(s);
      });
      return window.qrcode;
    }

    // Utility: estimate alphanumeric length -> QR alphanumeric capacity planning
    function isBase45Char(ch) {
      const alphabet = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:';
      return alphabet.indexOf(ch) >= 0;
    }

    function normalizeBase45PrefixInput(s) {
      // Uppercase and validate all chars are in Base45 alphabet (same as QR alphanumeric)
      const t = s.toUpperCase();
      for (const ch of t) {
        if (!isBase45Char(ch)) return { ok: false, val: t };
      }
      return { ok: true, val: t };
    }

    function alnumModeBits(str) {
      // QR alphanumeric mode encodes 2 chars -> 11 bits, last single char -> 6 bits
      const n = str.length;
      const pairs = Math.floor(n / 2);
      const single = n % 2;
      return pairs * 11 + single * 6;
    }

    import { minimalVersionForAlnum, calculateAlnumBits } from './qr_capacity.js?v=3';

    async function main() {
      await init();
      const uuidSpan = document.getElementById('uuid');
      const b45Span = document.getElementById('b45');
      const uuidOut = document.getElementById('uuid-out');
      const uuidIn = document.getElementById('uuid-in');
      const b45In = document.getElementById('b45-in');

      document.getElementById('btn-gen').addEventListener('click', () => {
        const u = wasm_gen_v4();
        uuidSpan.textContent = u;
        (uuidIn).value = u;
      });

      document.getElementById('btn-enc').addEventListener('click', async () => {
        try {
          const s = await wasm_encode_uuid_str(uuidIn.value.trim());
          b45Span.textContent = s;
          // Show QR button now that we have Base45
          document.getElementById('btn-qr').style.display = 'inline-block';
        } catch (e) {
          alert('Encode error: ' + e);
        }
      });

      document.getElementById('btn-dec').addEventListener('click', async () => {
        try {
          const s = await wasm_decode_to_uuid_str(b45In.value.trim());
          uuidOut.textContent = s;
        } catch (e) {
          alert('Decode error: ' + e);
        }
      });
    }

    document.getElementById('btn-qr').addEventListener('click', () => {
      document.getElementById('qr-config').style.display = 'block';
      document.getElementById('qr-options').style.display = 'none';
      document.getElementById('qr-view').innerHTML = '';
    });

    document.getElementById('btn-qr-confirm').addEventListener('click', async () => {
      const prefixRaw = (document.getElementById('qr-prefix')).value || '';
      const norm = normalizeBase45PrefixInput(prefixRaw);
      if (!norm.ok) { alert('Prefix contains characters outside Base45 alphabet. It has been uppercased: ' + norm.val); return; }
      const prefix = norm.val;
      const b45 = document.getElementById('b45').textContent.trim().toUpperCase();
      // Validate base45 payload characters
      for (const ch of b45) { if (!isBase45Char(ch)) { alert('Base45 content contains invalid characters.'); return; } }
      const payload = prefix + b45;
      const alnumBits = alnumModeBits(payload);
      const info = document.getElementById('qr-info');
      info.textContent = `Alphanumeric bits: ${alnumBits}`;
      info.style.display = 'block';
      const ecLevels = ['L','M','Q','H'];
      const opts = [];
      for (const ec of ecLevels) {
        const ver = minimalVersionForAlnum(payload.length, ec);
        if (ver) opts.push({ ec, ver });
      }
      const container = document.getElementById('qr-options');
      container.innerHTML = '';
      if (opts.length === 0) {
        container.textContent = 'Payload too large for versions up to 40 in alphanumeric mode.';
        container.style.display = 'block';
        return;
      }
      for (const {ec, ver} of opts) {
        const btn = document.createElement('button');
        btn.textContent = `v${ver} ${ec}`;
        btn.addEventListener('click', async () => {
          await loadQRLIB();
          // Using classic qrcode-generator global API
          const typeNumber = ver; // 1..40
          // qrcode-generator expects EC level as string: 'L', 'M', 'Q', or 'H'
          const qr = window.qrcode(typeNumber, ec);
          qr.addData(payload);
          qr.make();
          const svg = qr.createSvgTag(6, 0);
          const view = document.getElementById('qr-view');
          view.innerHTML = svg;
        });
        container.appendChild(btn);
      }
      container.style.display = 'block';
    });

    main();
  </script>
</body>
</html>
