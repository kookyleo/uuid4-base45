<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WASM Demo</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
    }
    input[type=text] {
      width: 360px;
      max-width: 100%;
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      white-space: pre;
    }
    .row { margin: 0.5rem 0; }
    .section {
      margin: 2rem 0;
      padding: 1.5rem;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fafafa;
    }
    .section h2 {
      margin-top: 0;
      font-size: 1.2rem;
      color: #333;
      border-bottom: 2px solid #ddd;
      padding-bottom: 0.5rem;
    }
    button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      margin-left: 8px;
    }
    button:hover {
      background: #f0f0f0;
    }
    button:active {
      background: #e0e0e0;
    }
    button.selected {
      background: #007bff;
      color: white;
      border-color: #0056b3;
    }
    button.selected:hover {
      background: #0056b3;
    }
    .info-text {
      color: #666;
      font-size: 0.9rem;
      margin-top: 0.3rem;
    }
  </style>
</head>
<body>
  <h1>WASM Demo</h1>
  <p>Generate UUID v4, encode to Base44 compact string, and decode back.</p>

  <!-- Encode Section -->
  <div class="section">
    <h2>Encode</h2>
    <div class="row">
      <button id="btn-gen">Generate v4</button>
      <span id="uuid"></span>
      <button id="btn-copy-uuid" style="display:none;">Copy</button>
    </div>
    <div class="row">
      <label>UUID input: <input type="text" id="uuid-in" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"></label>
      <button id="btn-enc">Encode</button>
    </div>
    <div class="row">
      <label>Base44: <code id="b45"></code></label>
      <button id="btn-copy-b45" style="display:none;">Copy</button>
      <button id="btn-qr" style="display:none;">Generate QR</button>
    </div>
  </div>

  <!-- QR Code Section -->
  <div class="section" id="qr-section" style="display:none;">
    <h2>QR Code</h2>
    <div class="row">
      <label>URL: <input type="text" id="qr-url" style="width:360px; max-width:100%"></label>
      <button id="btn-copy-url" style="display:none;">Copy</button>
      <button id="btn-qr-confirm">Generate</button>
    </div>
    <div class="row" id="qr-info" style="display:none;">
      <div class="info-text" id="qr-stats"></div>
    </div>
    <div class="row" id="qr-options" style="display:none;"></div>
    <div class="row" id="qr-view"></div>
  </div>

  <!-- Decode Section -->
  <div class="section">
    <h2>Decode</h2>
    <div class="row">
      <label>Base44 input: <input type="text" id="b45-in" placeholder="Base44 string"></label>
      <button id="btn-dec">Decode</button>
    </div>
    <div class="row">
      <label>Decoded UUID: <code id="uuid-out"></code></label>
      <button id="btn-copy-decoded" style="display:none;">Copy</button>
    </div>
  </div>

  <script type="module">
    import init, { wasm_gen_v4, wasm_encode_uuid_str, wasm_decode_to_uuid_str } from './pkg/uuid45.js';

    // Copy to clipboard helper
    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = 'Copied';
        setTimeout(() => {
          button.textContent = originalText;
        }, 1500);
      }).catch(err => {
        alert('Failed to copy: ' + err);
      });
    }

    // Minimal QR renderer using qrcode-generator (inline ESM loader)
    async function loadQRLIB() {
      if (window.qrcode) return window.qrcode;
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = './vendor/qrcode.js?v=' + Date.now();
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load local vendor qrcode.js'));
        document.head.appendChild(s);
      });
      return window.qrcode;
    }

    // Utility: validate Base44/QR alphanumeric characters (Base45 without space)
    function isBase44Char(ch) {
      const alphabet = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ$%*+-./:';
      return alphabet.indexOf(ch) >= 0;
    }

    function normalizeBase44Input(s) {
      // Uppercase and validate all chars are in Base44 alphabet (QR alphanumeric without space)
      const t = s.toUpperCase();
      for (const ch of t) {
        if (!isBase44Char(ch)) return { ok: false, val: t };
      }
      return { ok: true, val: t };
    }

    import { minimalVersionForAlnum, calculateAlnumBits } from './qr_capacity.js?v=4';

    async function main() {
      await init();
      const uuidSpan = document.getElementById('uuid');
      const b45Span = document.getElementById('b45');
      const uuidOut = document.getElementById('uuid-out');
      const uuidIn = document.getElementById('uuid-in');
      const b45In = document.getElementById('b45-in');
      const qrUrl = document.getElementById('qr-url');
      const btnCopyUuid = document.getElementById('btn-copy-uuid');
      const btnCopyB45 = document.getElementById('btn-copy-b45');
      const btnCopyUrl = document.getElementById('btn-copy-url');
      const btnCopyDecoded = document.getElementById('btn-copy-decoded');

      document.getElementById('btn-gen').addEventListener('click', () => {
        const u = wasm_gen_v4();
        uuidSpan.textContent = u;
        uuidIn.value = u;
        btnCopyUuid.style.display = 'inline-block';
      });

      btnCopyUuid.addEventListener('click', () => {
        copyToClipboard(uuidSpan.textContent, btnCopyUuid);
      });

      document.getElementById('btn-enc').addEventListener('click', async () => {
        try {
          const s = await wasm_encode_uuid_str(uuidIn.value.trim());
          b45Span.textContent = s;
          b45In.value = s;  // Auto-fill decode input
          btnCopyB45.style.display = 'inline-block';
          document.getElementById('btn-qr').style.display = 'inline-block';

          // Update QR URL with Base44
          qrUrl.value = 'https://lets.go/' + s;
          btnCopyUrl.style.display = 'inline-block';
        } catch (e) {
          alert('Encode error: ' + e);
        }
      });

      btnCopyB45.addEventListener('click', () => {
        copyToClipboard(b45Span.textContent, btnCopyB45);
      });

      btnCopyUrl.addEventListener('click', () => {
        copyToClipboard(qrUrl.value, btnCopyUrl);
      });

      document.getElementById('btn-dec').addEventListener('click', async () => {
        try {
          // Do not trim - preserve exact Base44 string
          const s = await wasm_decode_to_uuid_str(b45In.value);
          uuidOut.textContent = s;
          btnCopyDecoded.style.display = 'inline-block';
        } catch (e) {
          alert('Decode error: ' + e);
        }
      });

      btnCopyDecoded.addEventListener('click', () => {
        copyToClipboard(uuidOut.textContent, btnCopyDecoded);
      });
    }

    document.getElementById('btn-qr').addEventListener('click', () => {
      document.getElementById('qr-section').style.display = 'block';
      document.getElementById('qr-options').style.display = 'none';
      document.getElementById('qr-view').innerHTML = '';
    });

    document.getElementById('btn-qr-confirm').addEventListener('click', async () => {
      const urlRaw = document.getElementById('qr-url').value || '';
      const norm = normalizeBase44Input(urlRaw);
      if (!norm.ok) {
        alert('URL contains characters outside Base44/QR alphanumeric alphabet. It has been uppercased: ' + norm.val);
        return;
      }
      const payload = norm.val;

      // Calculate bits breakdown
      const payloadLen = payload.length;
      const pairs = Math.floor(payloadLen / 2);
      const single = payloadLen % 2;
      const dataBits = pairs * 11 + single * 6;

      // Display detailed stats
      const statsDiv = document.getElementById('qr-stats');
      statsDiv.innerHTML = `
        <strong>Payload:</strong> ${payloadLen} chars<br>
        <strong>Data bits:</strong> ${dataBits} bits (${pairs} pairs × 11 + ${single} single × 6)<br>
        <strong>Total QR bits:</strong> mode(4) + count(9-13) + data(${dataBits}) + terminator(0-4) + padding
      `;
      document.getElementById('qr-info').style.display = 'block';

      const ecLevels = ['L','M','Q','H'];
      const opts = [];
      for (const ec of ecLevels) {
        const ver = minimalVersionForAlnum(payloadLen, ec);
        if (ver) {
          const totalBits = calculateAlnumBits(payloadLen, ver);
          opts.push({ ec, ver, totalBits });
        }
      }

      const container = document.getElementById('qr-options');
      container.innerHTML = '';
      if (opts.length === 0) {
        container.textContent = 'Payload too large for versions up to 40 in alphanumeric mode.';
        container.style.display = 'block';
        return;
      }

      let firstBtn = null;
      for (const {ec, ver, totalBits} of opts) {
        const btn = document.createElement('button');
        btn.textContent = `v${ver} ${ec} (${totalBits} bits)`;
        btn.addEventListener('click', async () => {
          // Remove selected class from all buttons
          container.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
          // Add selected class to clicked button
          btn.classList.add('selected');

          await loadQRLIB();
          const qr = window.qrcode(ver, ec);
          qr.addData(payload, 'Alphanumeric');
          qr.make();
          const svg = qr.createSvgTag(6, 0);
          const view = document.getElementById('qr-view');
          view.innerHTML = svg;
        });
        container.appendChild(btn);
        if (!firstBtn) firstBtn = btn;
      }
      container.style.display = 'block';

      // Auto-generate first option
      if (firstBtn) {
        firstBtn.click();
      }
    });

    main();
  </script>
</body>
</html>
